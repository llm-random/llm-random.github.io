<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.361">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Szymon Antoniak *">
<meta name="author" content="Michał Krutul">
<meta name="author" content="Maciej Pióro">
<meta name="author" content="Jakub Krajewski">
<meta name="author" content="Jan Ludziejewski">
<meta name="author" content="Tomasz Odrzygóźdź">
<meta name="author" content="Marek Cygan ‡">
<meta name="author" content="Sebastian Jaszczur †">
<meta name="dcterms.date" content="2023-09-29">

<title>llm-random – RAW HTML CONTENT</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script charset="utf-8" src="https://cdn.plot.ly/plotly-2.20.0.min.js">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">llm-random</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">RAW HTML CONTENT</h1>
                      </div>
  </div>
    
  <div class="quarto-title-meta-author">
    <div class="quarto-title-meta-heading">Authors</div>
    <div class="quarto-title-meta-heading">Affiliations</div>
    
      <div class="quarto-title-meta-contents">
      <p class="author">Szymon Antoniak * </p>
    </div>
      <div class="quarto-title-meta-contents">
          <p class="affiliation">
              IDEAS NCBR
            </p>
          <p class="affiliation">
              University of Warsaw
            </p>
        </div>
        <div class="quarto-title-meta-contents">
      <p class="author">Michał Krutul </p>
    </div>
      <div class="quarto-title-meta-contents">
          <p class="affiliation">
              IDEAS NCBR
            </p>
          <p class="affiliation">
              University of Warsaw
            </p>
        </div>
        <div class="quarto-title-meta-contents">
      <p class="author">Maciej Pióro </p>
    </div>
      <div class="quarto-title-meta-contents">
          <p class="affiliation">
              IDEAS NCBR
            </p>
          <p class="affiliation">
              University of Warsaw
            </p>
        </div>
        <div class="quarto-title-meta-contents">
      <p class="author">Jakub Krajewski </p>
    </div>
      <div class="quarto-title-meta-contents">
          <p class="affiliation">
              IDEAS NCBR
            </p>
          <p class="affiliation">
              University of Warsaw
            </p>
        </div>
        <div class="quarto-title-meta-contents">
      <p class="author">Jan Ludziejewski </p>
    </div>
      <div class="quarto-title-meta-contents">
          <p class="affiliation">
              IDEAS NCBR
            </p>
          <p class="affiliation">
              University of Warsaw
            </p>
        </div>
        <div class="quarto-title-meta-contents">
      <p class="author">Tomasz Odrzygóźdź </p>
    </div>
      <div class="quarto-title-meta-contents">
          <p class="affiliation">
              IDEAS NCBR
            </p>
          <p class="affiliation">
              University of Warsaw
            </p>
        </div>
        <div class="quarto-title-meta-contents">
      <p class="author">Marek Cygan ‡ </p>
    </div>
      <div class="quarto-title-meta-contents">
          <p class="affiliation">
              University of Warsaw
            </p>
          <p class="affiliation">
              Nomagic
            </p>
        </div>
        <div class="quarto-title-meta-contents">
      <p class="author">Sebastian Jaszczur † </p>
    </div>
      <div class="quarto-title-meta-contents">
          <p class="affiliation">
              IDEAS NCBR
            </p>
          <p class="affiliation">
              University of Warsaw
            </p>
        </div>
      </div>

  <div class="quarto-title-meta">

        
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">September 29, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>Mixture of Experts architectures have recently garnerned considerable attention for their ability to increase the size of Transformer architectures while keeping the computational cost of training and inference constant. The most successful MoE approaches achieve this by activating only subsets of a very large feed forward layer for each processed token.</p>
<p>This technique comes at a cost, though: the choice of that subset of parameters for a given token is a discrete operation, and as such its training requires either the use of gradient estimators for traditional gradient-based optimisation or non-gradient based techniques; the models are known to suffer from issues such as training instability, under- and overload of <em>experts</em> (subsets of the FeedForward layer) and more. While some of those problems can be alleviated with e.g.&nbsp;the use of various auxiliary losses or reduced initialisation scale, it is certain that existing MoE techniques are more difficult and less intuitive to train.</p>
<p>With this motivation, we propose Mixture of Tokens: a new, fully-differentiable type of architecture that retains all efficiency benefits of MoE and alleviates the aformentioned problem by mixing <em>tokens</em> before feeding them into the FeedForward layer. This technique is fully compatible with both masked and causual LLM training.</p>
</section>
<section id="motivation" class="level1">
<h1>Motivation</h1>
<section id="scaling-with-mixture-of-experts" class="level2">
<h2 class="anchored" data-anchor-id="scaling-with-mixture-of-experts">Scaling with Mixture of Experts</h2>
<p>Existing Mixture of Experts approaches have demonstrated very impressive results in training huge models for language <span class="citation" data-cites="Switch">(<a href="#ref-Switch" role="doc-biblioref"><strong>Switch?</strong></a>)</span>, vision <span class="citation" data-cites="moe_vision">(<a href="#ref-moe_vision" role="doc-biblioref"><strong>moe_vision?</strong></a>)</span> and more <span class="citation" data-cites="moe_multimodal">(<a href="#ref-moe_multimodal" role="doc-biblioref"><strong>moe_multimodal?</strong></a>)</span>. The core idea is to replace the FeedForward layer standard for Transformer architectures with a set of <em>experts</em>, usually also MLPs, and have each token be processed by a subset of experts.</p>


<title>generic_moe</title>
<meta charset="utf-8">

<div class="mxgraph" style="max-width:100%;border:1px solid transparent;" data-mxgraph="{&quot;highlight&quot;:&quot;#0000ff&quot;,&quot;nav&quot;:true,&quot;resize&quot;:true,&quot;toolbar&quot;:&quot;zoom layers tags lightbox&quot;,&quot;edit&quot;:&quot;_blank&quot;,&quot;xml&quot;:&quot;<mxfile host=\&quot;app.diagrams.net\&quot; modified=\&quot;2023-10-02T16:14:50.668Z\&quot; agent=\&quot;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/118.0\&quot; etag=\&quot;bNLqouWxuNlX6NyIyFeK\&quot; version=\&quot;21.6.5\&quot; type=\&quot;google\&quot;>\n  <diagram name=\&quot;Page-1\&quot; id=\&quot;Ooj4VCty3gAyGvrI8WI3\&quot;>\n    <mxGraphModel dx=\&quot;1602\&quot; dy=\&quot;2964\&quot; grid=\&quot;1\&quot; gridSize=\&quot;10\&quot; guides=\&quot;1\&quot; tooltips=\&quot;1\&quot; connect=\&quot;1\&quot; arrows=\&quot;1\&quot; fold=\&quot;1\&quot; page=\&quot;1\&quot; pageScale=\&quot;1\&quot; pageWidth=\&quot;827\&quot; pageHeight=\&quot;1169\&quot; math=\&quot;0\&quot; shadow=\&quot;0\&quot;>\n      <root>\n        <mxCell id=\&quot;0\&quot; />\n        <mxCell id=\&quot;1\&quot; parent=\&quot;0\&quot; />\n        <mxCell id=\&quot;FTCFTmSgrVzz-DVGMluv-1\&quot; value=\&quot;&amp;lt;font color=&amp;quot;#363636&amp;quot; style=&amp;quot;font-size: 11px;&amp;quot;&amp;gt;ATTENTION&amp;lt;/font&amp;gt;\&quot; style=\&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#592927;fontSize=11;\&quot; parent=\&quot;1\&quot; vertex=\&quot;1\&quot;>\n          <mxGeometry x=\&quot;39\&quot; y=\&quot;-932\&quot; width=\&quot;81\&quot; height=\&quot;40\&quot; as=\&quot;geometry\&quot; />\n        </mxCell>\n        <mxCell id=\&quot;FTCFTmSgrVzz-DVGMluv-2\&quot; value=\&quot;\&quot; style=\&quot;endArrow=none;html=1;rounded=0;strokeWidth=1;strokeColor=#4D4D4D;\&quot; parent=\&quot;1\&quot; edge=\&quot;1\&quot;>\n          <mxGeometry width=\&quot;50\&quot; height=\&quot;50\&quot; relative=\&quot;1\&quot; as=\&quot;geometry\&quot;>\n            <mxPoint x=\&quot;10\&quot; y=\&quot;-822\&quot; as=\&quot;sourcePoint\&quot; />\n            <mxPoint x=\&quot;10\&quot; y=\&quot;-1152\&quot; as=\&quot;targetPoint\&quot; />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\&quot;FTCFTmSgrVzz-DVGMluv-6\&quot; value=\&quot;&amp;lt;font color=&amp;quot;#363636&amp;quot;&amp;gt;FFN&amp;lt;/font&amp;gt;\&quot; style=\&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#000066;\&quot; parent=\&quot;1\&quot; vertex=\&quot;1\&quot;>\n          <mxGeometry x=\&quot;40\&quot; y=\&quot;-1082\&quot; width=\&quot;80\&quot; height=\&quot;40\&quot; as=\&quot;geometry\&quot; />\n        </mxCell>\n        <mxCell id=\&quot;FTCFTmSgrVzz-DVGMluv-9\&quot; value=\&quot;&amp;lt;font color=&amp;quot;#363636&amp;quot;&amp;gt;FFN&amp;lt;/font&amp;gt;\&quot; style=\&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#000066;fontFamily=Helvetica;\&quot; parent=\&quot;1\&quot; vertex=\&quot;1\&quot;>\n          <mxGeometry x=\&quot;371\&quot; y=\&quot;-1010\&quot; width=\&quot;79\&quot; height=\&quot;40\&quot; as=\&quot;geometry\&quot; />\n        </mxCell>\n        <mxCell id=\&quot;FTCFTmSgrVzz-DVGMluv-24\&quot; value=\&quot;\&quot; style=\&quot;endArrow=classic;html=1;rounded=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;startSize=3;endSize=3;strokeColor=#4D4D4D;\&quot; parent=\&quot;1\&quot; target=\&quot;FTCFTmSgrVzz-DVGMluv-9\&quot; edge=\&quot;1\&quot;>\n          <mxGeometry width=\&quot;50\&quot; height=\&quot;50\&quot; relative=\&quot;1\&quot; as=\&quot;geometry\&quot;>\n            <mxPoint x=\&quot;410\&quot; y=\&quot;-930\&quot; as=\&quot;sourcePoint\&quot; />\n            <mxPoint x=\&quot;410\&quot; y=\&quot;-960\&quot; as=\&quot;targetPoint\&quot; />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\&quot;FTCFTmSgrVzz-DVGMluv-25\&quot; value=\&quot;\&quot; style=\&quot;endArrow=classic;html=1;rounded=0;startSize=3;endSize=3;strokeColor=#4D4D4D;\&quot; parent=\&quot;1\&quot; edge=\&quot;1\&quot;>\n          <mxGeometry width=\&quot;50\&quot; height=\&quot;50\&quot; relative=\&quot;1\&quot; as=\&quot;geometry\&quot;>\n            <mxPoint x=\&quot;410\&quot; y=\&quot;-1010\&quot; as=\&quot;sourcePoint\&quot; />\n            <mxPoint x=\&quot;410\&quot; y=\&quot;-1050\&quot; as=\&quot;targetPoint\&quot; />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\&quot;FTCFTmSgrVzz-DVGMluv-26\&quot; value=\&quot;&amp;lt;font color=&amp;quot;#363636&amp;quot; style=&amp;quot;font-size: 11px;&amp;quot;&amp;gt;controller&amp;lt;/font&amp;gt;\&quot; style=\&quot;rounded=0;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=11;\&quot; parent=\&quot;1\&quot; vertex=\&quot;1\&quot;>\n          <mxGeometry x=\&quot;670\&quot; y=\&quot;-880\&quot; width=\&quot;60\&quot; height=\&quot;20\&quot; as=\&quot;geometry\&quot; />\n        </mxCell>\n        <mxCell id=\&quot;FTCFTmSgrVzz-DVGMluv-27\&quot; value=\&quot;\&quot; style=\&quot;endArrow=classic;html=1;rounded=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endSize=3;strokeColor=#4D4D4D;\&quot; parent=\&quot;1\&quot; target=\&quot;FTCFTmSgrVzz-DVGMluv-26\&quot; edge=\&quot;1\&quot;>\n          <mxGeometry width=\&quot;50\&quot; height=\&quot;50\&quot; relative=\&quot;1\&quot; as=\&quot;geometry\&quot;>\n            <mxPoint x=\&quot;700\&quot; y=\&quot;-820\&quot; as=\&quot;sourcePoint\&quot; />\n            <mxPoint x=\&quot;310\&quot; y=\&quot;-1040\&quot; as=\&quot;targetPoint\&quot; />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\&quot;FTCFTmSgrVzz-DVGMluv-33\&quot; value=\&quot;\&quot; style=\&quot;endArrow=blockThin;dashed=1;html=1;dashPattern=1 3;strokeWidth=1;rounded=0;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endSize=4;endFill=0;strokeColor=#4D4D4D;\&quot; parent=\&quot;1\&quot; source=\&quot;FTCFTmSgrVzz-DVGMluv-26\&quot; edge=\&quot;1\&quot;>\n          <mxGeometry width=\&quot;50\&quot; height=\&quot;50\&quot; relative=\&quot;1\&quot; as=\&quot;geometry\&quot;>\n            <mxPoint x=\&quot;710\&quot; y=\&quot;-870\&quot; as=\&quot;sourcePoint\&quot; />\n            <mxPoint x=\&quot;839.5\&quot; y=\&quot;-970\&quot; as=\&quot;targetPoint\&quot; />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\&quot;FTCFTmSgrVzz-DVGMluv-34\&quot; value=\&quot;\&quot; style=\&quot;endArrow=blockThin;dashed=1;html=1;dashPattern=1 3;strokeWidth=1;rounded=0;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endSize=4;endFill=0;strokeColor=#4D4D4D;\&quot; parent=\&quot;1\&quot; source=\&quot;FTCFTmSgrVzz-DVGMluv-26\&quot; edge=\&quot;1\&quot;>\n          <mxGeometry width=\&quot;50\&quot; height=\&quot;50\&quot; relative=\&quot;1\&quot; as=\&quot;geometry\&quot;>\n            <mxPoint x=\&quot;710\&quot; y=\&quot;-870\&quot; as=\&quot;sourcePoint\&quot; />\n            <mxPoint x=\&quot;749.5\&quot; y=\&quot;-970\&quot; as=\&quot;targetPoint\&quot; />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\&quot;FTCFTmSgrVzz-DVGMluv-35\&quot; value=\&quot;\&quot; style=\&quot;endArrow=blockThin;dashed=1;html=1;dashPattern=1 3;strokeWidth=1;rounded=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endSize=4;endFill=0;exitX=0.5;exitY=0;exitDx=0;exitDy=0;strokeColor=#4D4D4D;\&quot; parent=\&quot;1\&quot; source=\&quot;FTCFTmSgrVzz-DVGMluv-26\&quot; edge=\&quot;1\&quot;>\n          <mxGeometry width=\&quot;50\&quot; height=\&quot;50\&quot; relative=\&quot;1\&quot; as=\&quot;geometry\&quot;>\n            <mxPoint x=\&quot;700\&quot; y=\&quot;-880\&quot; as=\&quot;sourcePoint\&quot; />\n            <mxPoint x=\&quot;659.5\&quot; y=\&quot;-970\&quot; as=\&quot;targetPoint\&quot; />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\&quot;FTCFTmSgrVzz-DVGMluv-38\&quot; value=\&quot;&amp;lt;font color=&amp;quot;#363636&amp;quot;&amp;gt;FFN1&amp;lt;/font&amp;gt;\&quot; style=\&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#000066;fontFamily=Helvetica;\&quot; parent=\&quot;1\&quot; vertex=\&quot;1\&quot;>\n          <mxGeometry x=\&quot;531\&quot; y=\&quot;-1010\&quot; width=\&quot;79\&quot; height=\&quot;40\&quot; as=\&quot;geometry\&quot; />\n        </mxCell>\n        <mxCell id=\&quot;FTCFTmSgrVzz-DVGMluv-39\&quot; value=\&quot;&amp;lt;font color=&amp;quot;#363636&amp;quot;&amp;gt;FFN2&amp;lt;/font&amp;gt;\&quot; style=\&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#000066;fontFamily=Helvetica;\&quot; parent=\&quot;1\&quot; vertex=\&quot;1\&quot;>\n          <mxGeometry x=\&quot;621\&quot; y=\&quot;-1010\&quot; width=\&quot;79\&quot; height=\&quot;40\&quot; as=\&quot;geometry\&quot; />\n        </mxCell>\n        <mxCell id=\&quot;FTCFTmSgrVzz-DVGMluv-40\&quot; value=\&quot;&amp;lt;font color=&amp;quot;#363636&amp;quot;&amp;gt;FFN3&amp;lt;/font&amp;gt;\&quot; style=\&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#000066;fontFamily=Helvetica;\&quot; parent=\&quot;1\&quot; vertex=\&quot;1\&quot;>\n          <mxGeometry x=\&quot;711\&quot; y=\&quot;-1010\&quot; width=\&quot;79\&quot; height=\&quot;40\&quot; as=\&quot;geometry\&quot; />\n        </mxCell>\n        <mxCell id=\&quot;FTCFTmSgrVzz-DVGMluv-41\&quot; value=\&quot;&amp;lt;font color=&amp;quot;#363636&amp;quot;&amp;gt;FFN4&amp;lt;/font&amp;gt;\&quot; style=\&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#000066;fontFamily=Helvetica;\&quot; parent=\&quot;1\&quot; vertex=\&quot;1\&quot;>\n          <mxGeometry x=\&quot;801\&quot; y=\&quot;-1010\&quot; width=\&quot;79\&quot; height=\&quot;40\&quot; as=\&quot;geometry\&quot; />\n        </mxCell>\n        <mxCell id=\&quot;FTCFTmSgrVzz-DVGMluv-45\&quot; value=\&quot;\&quot; style=\&quot;endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=1;rounded=0;endSize=0;endFill=0;exitX=0.456;exitY=-0.079;exitDx=0;exitDy=0;exitPerimeter=0;entryX=1;entryY=1;entryDx=0;entryDy=0;startSize=0;strokeColor=#4D4D4D;\&quot; parent=\&quot;1\&quot; source=\&quot;FTCFTmSgrVzz-DVGMluv-41\&quot; target=\&quot;FTCFTmSgrVzz-DVGMluv-49\&quot; edge=\&quot;1\&quot;>\n          <mxGeometry width=\&quot;50\&quot; height=\&quot;50\&quot; relative=\&quot;1\&quot; as=\&quot;geometry\&quot;>\n            <mxPoint x=\&quot;761\&quot; y=\&quot;-1000\&quot; as=\&quot;sourcePoint\&quot; />\n            <mxPoint x=\&quot;760\&quot; y=\&quot;-1090\&quot; as=\&quot;targetPoint\&quot; />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\&quot;FTCFTmSgrVzz-DVGMluv-48\&quot; value=\&quot;\&quot; style=\&quot;endArrow=blockThin;dashed=1;html=1;dashPattern=1 3;strokeWidth=1;rounded=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endSize=4;endFill=0;exitX=0.5;exitY=0;exitDx=0;exitDy=0;strokeColor=#4D4D4D;\&quot; parent=\&quot;1\&quot; source=\&quot;FTCFTmSgrVzz-DVGMluv-26\&quot; target=\&quot;FTCFTmSgrVzz-DVGMluv-38\&quot; edge=\&quot;1\&quot;>\n          <mxGeometry width=\&quot;50\&quot; height=\&quot;50\&quot; relative=\&quot;1\&quot; as=\&quot;geometry\&quot;>\n            <mxPoint x=\&quot;710\&quot; y=\&quot;-870\&quot; as=\&quot;sourcePoint\&quot; />\n            <mxPoint x=\&quot;669.5\&quot; y=\&quot;-960\&quot; as=\&quot;targetPoint\&quot; />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\&quot;FTCFTmSgrVzz-DVGMluv-49\&quot; value=\&quot;\&quot; style=\&quot;ellipse;whiteSpace=wrap;html=1;aspect=fixed;strokeColor=#4D4D4D;\&quot; parent=\&quot;1\&quot; vertex=\&quot;1\&quot;>\n          <mxGeometry x=\&quot;703\&quot; y=\&quot;-1101\&quot; width=\&quot;3\&quot; height=\&quot;3\&quot; as=\&quot;geometry\&quot; />\n        </mxCell>\n        <mxCell id=\&quot;FTCFTmSgrVzz-DVGMluv-50\&quot; value=\&quot;\&quot; style=\&quot;endArrow=classic;html=1;rounded=0;startSize=3;endSize=3;strokeColor=#4D4D4D;\&quot; parent=\&quot;1\&quot; source=\&quot;FTCFTmSgrVzz-DVGMluv-49\&quot; edge=\&quot;1\&quot;>\n          <mxGeometry width=\&quot;50\&quot; height=\&quot;50\&quot; relative=\&quot;1\&quot; as=\&quot;geometry\&quot;>\n            <mxPoint x=\&quot;709.9999999999998\&quot; y=\&quot;-1130\&quot; as=\&quot;sourcePoint\&quot; />\n            <mxPoint x=\&quot;705\&quot; y=\&quot;-1140\&quot; as=\&quot;targetPoint\&quot; />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\&quot;FTCFTmSgrVzz-DVGMluv-51\&quot; value=\&quot;\&quot; style=\&quot;endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=1;rounded=0;endSize=0;endFill=0;exitX=0.5;exitY=0;exitDx=0;exitDy=0;strokeColor=#4D4D4D;\&quot; parent=\&quot;1\&quot; source=\&quot;FTCFTmSgrVzz-DVGMluv-40\&quot; target=\&quot;FTCFTmSgrVzz-DVGMluv-49\&quot; edge=\&quot;1\&quot;>\n          <mxGeometry width=\&quot;50\&quot; height=\&quot;50\&quot; relative=\&quot;1\&quot; as=\&quot;geometry\&quot;>\n            <mxPoint x=\&quot;847\&quot; y=\&quot;-1003\&quot; as=\&quot;sourcePoint\&quot; />\n            <mxPoint x=\&quot;738\&quot; y=\&quot;-1102\&quot; as=\&quot;targetPoint\&quot; />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\&quot;FTCFTmSgrVzz-DVGMluv-52\&quot; value=\&quot;\&quot; style=\&quot;endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=1;rounded=0;endSize=0;endFill=0;exitX=0.5;exitY=0;exitDx=0;exitDy=0;strokeColor=#4D4D4D;\&quot; parent=\&quot;1\&quot; source=\&quot;FTCFTmSgrVzz-DVGMluv-39\&quot; target=\&quot;FTCFTmSgrVzz-DVGMluv-49\&quot; edge=\&quot;1\&quot;>\n          <mxGeometry width=\&quot;50\&quot; height=\&quot;50\&quot; relative=\&quot;1\&quot; as=\&quot;geometry\&quot;>\n            <mxPoint x=\&quot;761\&quot; y=\&quot;-1000\&quot; as=\&quot;sourcePoint\&quot; />\n            <mxPoint x=\&quot;724\&quot; y=\&quot;-1093\&quot; as=\&quot;targetPoint\&quot; />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\&quot;FTCFTmSgrVzz-DVGMluv-53\&quot; value=\&quot;\&quot; style=\&quot;endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=1;rounded=0;endSize=0;endFill=0;exitX=0.5;exitY=0;exitDx=0;exitDy=0;strokeColor=#4D4D4D;\&quot; parent=\&quot;1\&quot; source=\&quot;FTCFTmSgrVzz-DVGMluv-38\&quot; target=\&quot;FTCFTmSgrVzz-DVGMluv-49\&quot; edge=\&quot;1\&quot;>\n          <mxGeometry width=\&quot;50\&quot; height=\&quot;50\&quot; relative=\&quot;1\&quot; as=\&quot;geometry\&quot;>\n            <mxPoint x=\&quot;671\&quot; y=\&quot;-1000\&quot; as=\&quot;sourcePoint\&quot; />\n            <mxPoint x=\&quot;698\&quot; y=\&quot;-1092\&quot; as=\&quot;targetPoint\&quot; />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\&quot;FTCFTmSgrVzz-DVGMluv-57\&quot; value=\&quot;\&quot; style=\&quot;curved=1;endArrow=classic;html=1;rounded=0;exitX=0.5;exitY=0;exitDx=0;exitDy=0;strokeColor=#4D4D4D;startSize=10;endSize=3;\&quot; parent=\&quot;1\&quot; source=\&quot;FTCFTmSgrVzz-DVGMluv-6\&quot; edge=\&quot;1\&quot;>\n          <mxGeometry width=\&quot;50\&quot; height=\&quot;50\&quot; relative=\&quot;1\&quot; as=\&quot;geometry\&quot;>\n            <mxPoint x=\&quot;120\&quot; y=\&quot;-1082\&quot; as=\&quot;sourcePoint\&quot; />\n            <mxPoint x=\&quot;10\&quot; y=\&quot;-1112\&quot; as=\&quot;targetPoint\&quot; />\n            <Array as=\&quot;points\&quot;>\n              <mxPoint x=\&quot;80\&quot; y=\&quot;-1112\&quot; />\n              <mxPoint x=\&quot;30\&quot; y=\&quot;-1112\&quot; />\n            </Array>\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\&quot;FTCFTmSgrVzz-DVGMluv-59\&quot; value=\&quot;\&quot; style=\&quot;endArrow=none;dashed=1;html=1;rounded=0;strokeColor=#4D4D4D;dashPattern=1 2;\&quot; parent=\&quot;1\&quot; edge=\&quot;1\&quot;>\n          <mxGeometry width=\&quot;50\&quot; height=\&quot;50\&quot; relative=\&quot;1\&quot; as=\&quot;geometry\&quot;>\n            <mxPoint x=\&quot;10\&quot; y=\&quot;-1152\&quot; as=\&quot;sourcePoint\&quot; />\n            <mxPoint x=\&quot;10\&quot; y=\&quot;-1172\&quot; as=\&quot;targetPoint\&quot; />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\&quot;FTCFTmSgrVzz-DVGMluv-60\&quot; value=\&quot;\&quot; style=\&quot;endArrow=none;dashed=1;html=1;rounded=0;strokeColor=#4D4D4D;dashPattern=1 2;\&quot; parent=\&quot;1\&quot; edge=\&quot;1\&quot;>\n          <mxGeometry width=\&quot;50\&quot; height=\&quot;50\&quot; relative=\&quot;1\&quot; as=\&quot;geometry\&quot;>\n            <mxPoint x=\&quot;10\&quot; y=\&quot;-802\&quot; as=\&quot;sourcePoint\&quot; />\n            <mxPoint x=\&quot;10\&quot; y=\&quot;-822\&quot; as=\&quot;targetPoint\&quot; />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\&quot;FTCFTmSgrVzz-DVGMluv-68\&quot; value=\&quot;\&quot; style=\&quot;curved=1;endArrow=classic;html=1;rounded=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;strokeColor=#4D4D4D;endSize=3;\&quot; parent=\&quot;1\&quot; target=\&quot;FTCFTmSgrVzz-DVGMluv-6\&quot; edge=\&quot;1\&quot;>\n          <mxGeometry width=\&quot;50\&quot; height=\&quot;50\&quot; relative=\&quot;1\&quot; as=\&quot;geometry\&quot;>\n            <mxPoint x=\&quot;10\&quot; y=\&quot;-992\&quot; as=\&quot;sourcePoint\&quot; />\n            <mxPoint x=\&quot;110\&quot; y=\&quot;-1042\&quot; as=\&quot;targetPoint\&quot; />\n            <Array as=\&quot;points\&quot;>\n              <mxPoint x=\&quot;10\&quot; y=\&quot;-1012\&quot; />\n              <mxPoint x=\&quot;40\&quot; y=\&quot;-1012\&quot; />\n              <mxPoint x=\&quot;80\&quot; y=\&quot;-1012\&quot; />\n            </Array>\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\&quot;FTCFTmSgrVzz-DVGMluv-69\&quot; value=\&quot;\&quot; style=\&quot;curved=1;endArrow=classic;html=1;rounded=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;strokeColor=#4D4D4D;endSize=3;\&quot; parent=\&quot;1\&quot; edge=\&quot;1\&quot;>\n          <mxGeometry width=\&quot;50\&quot; height=\&quot;50\&quot; relative=\&quot;1\&quot; as=\&quot;geometry\&quot;>\n            <mxPoint x=\&quot;10\&quot; y=\&quot;-842\&quot; as=\&quot;sourcePoint\&quot; />\n            <mxPoint x=\&quot;80\&quot; y=\&quot;-892\&quot; as=\&quot;targetPoint\&quot; />\n            <Array as=\&quot;points\&quot;>\n              <mxPoint x=\&quot;10\&quot; y=\&quot;-862\&quot; />\n              <mxPoint x=\&quot;40\&quot; y=\&quot;-862\&quot; />\n              <mxPoint x=\&quot;80\&quot; y=\&quot;-862\&quot; />\n            </Array>\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\&quot;FTCFTmSgrVzz-DVGMluv-70\&quot; value=\&quot;\&quot; style=\&quot;curved=1;endArrow=classic;html=1;rounded=0;exitX=0.5;exitY=0;exitDx=0;exitDy=0;strokeColor=#4D4D4D;startSize=10;endSize=3;\&quot; parent=\&quot;1\&quot; edge=\&quot;1\&quot;>\n          <mxGeometry width=\&quot;50\&quot; height=\&quot;50\&quot; relative=\&quot;1\&quot; as=\&quot;geometry\&quot;>\n            <mxPoint x=\&quot;80\&quot; y=\&quot;-932\&quot; as=\&quot;sourcePoint\&quot; />\n            <mxPoint x=\&quot;10\&quot; y=\&quot;-962\&quot; as=\&quot;targetPoint\&quot; />\n            <Array as=\&quot;points\&quot;>\n              <mxPoint x=\&quot;80\&quot; y=\&quot;-962\&quot; />\n              <mxPoint x=\&quot;30\&quot; y=\&quot;-962\&quot; />\n            </Array>\n          </mxGeometry>\n        </mxCell>\n      </root>\n    </mxGraphModel>\n  </diagram>\n</mxfile>\n&quot;}"></div>
<script type="text/javascript" src="https://viewer.diagrams.net/js/viewer-static.min.js"></script>


<p>The increased model size, despite keeping computational cost during training and inference constant, leads to significant performance improvements, and has been shown to behave predictably with respect to parameter count and inference compute [scaling moe], similarly to the standard dense Transformer models [scaling,chinchilla].</p>
<p>However, following the success of those initial huge parameter-count models, thorough analysis of the model training and inference schemes uncovered that using Mixture of Experts techiques brings about an entirely new suite of challenges.</p>
</section>
<section id="mixture-of-experts-a-quick-recap" class="level2">
<h2 class="anchored" data-anchor-id="mixture-of-experts-a-quick-recap">Mixture of Experts: A Quick Recap</h2>
<p>In recent years, there has been a growing interest in methods of increasing the number of parameters in neural networks while maintaining their computational demands. A major advance in eliminating some problems with traditional MoE approaches is Expert Choice (here biblio). Our work has been inspired by their approach - MoT can be seen as an Expert Choice (as opposed to <em>Token Choice</em>) kind of method.</p>
<p>There is also concurrent work (Softmoe) investigating ideas similar to ours in the vision domain. It is, however, limited to encoder-only models. It is worth noting that earlier, other fully-differentiable MoE approaches had been proposed (biblio copied from Softmoe). /* jakoś inaczej sformułowac: However, expert-mixing strategies presented in those works incur significant computational overhead. Also, they are token choice instead of expert choice, so different than us. */</p>
</section>
<section id="limitations-of-current-approaches-sekcja-8.2-w-paperze-sa" class="level2">
<h2 class="anchored" data-anchor-id="limitations-of-current-approaches-sekcja-8.2-w-paperze-sa">Limitations of Current Approaches (sekcja 8.2 w paperze) SA</h2>
<!-- JK - byłoby bardziej logicze dać tę sekcję pod related work -->
<p>Without mentioning papers - obecne podejścia są niestabilne - mamy idealny balancing token -&gt; expert</p>
<p>with training stability, management of expert <em>load</em> (how many tokens are routed to each expert) that lead to time overheads, mode collapse (all tokens routed to a small portion of the expert set), leaving some tokens unprocessed, problems with expert exploration and specialization/redundancy, low performance of discrete operations on accelerators and finally communication costs in parallel training.</p>
</section>
</section>
<section id="method" class="level1">
<h1>Method</h1>
<ul>
<li>Diagram SJ</li>
</ul>
<iframe width="780" height="500" src="https://viewer.diagrams.net/index.html?tags=%7B%7D&amp;highlight=0000ff&amp;edit=_blank&amp;layers=1&amp;nav=1&amp;page-id=abJAIyk8VqZmFR_1QRqh&amp;title=Untitled%20Diagram.drawio#Uhttps%3A%2F%2Fdrive.google.com%2Fuc%3Fid%3D1jvew0ft43zpaG-iCk7Ob2ilJw7VjsyeZ%26export%3Ddownload#%7B%22pageId%22%3A%22abJAIyk8VqZmFR_1QRqh%22%7D
" title="Figure">
<section id="implementation" class="level2">
<h2>Implementation</h2>
<!-- MK -->
<p>In the first phase of our MoT Layer, we partition batch sequences into groups of tokens, ensuring each group is of equal size.</p>
<p>For each group, we acquire a set of weights, named merge and emit. The sum of weights in both merge and emit equals 1 for every group, signifying the percentage of each token to utilize.</p>
<p>In every group, using merge weights, we consolidate each token group into a single token. Following this, we process all merged tokens with linear experts’ weights and a relu activation function. Employing emit weights, we redistribute resultant tokens from the experts’ layer back to a group of tokens.</p>
<p>Lastly, we disassemble the groups to align with the MoT input dimensions. - encoder vs decoder MP</p>
</section>
<section id="encoder-vs-decoder" class="level2">
<h2>Encoder vs Decoder</h2>
<p>In encoder-only models, each token may attend to the whole input sequence, whereas decoder-only models only allow attending to the tokens that came before a particular token to simulate the autoregressive decoding used during model inference. This is crucial for the training of decoder-only models, as allowing a token to attend to future tokens would constitute a data leak, preventing successful training. A major problem potentially facing any token-mixing strategy is the possibility of a data leak, making the strategy inappropriate for use with decoder-only models. In MoT, the tokens are mixed across batch, i.e. with other tokens at the same position in other samples in the same training batch. We don’t consider other strategies which would be more suitable in the context of encoders.</p>
</section>
</section>
<section id="experiments-mp-sa" class="level1">
<h1>Experiments MP / SA</h1>
<section id="experimental-setup" class="level2">
<h2>Experimental setup</h2>
<p>In our experiments we train the models for <span class="math inline">\(250{,}000\)</span> steps using a cosine LR scheduler with <span class="math inline">\(2500\)</span> steps of warmup, and final LR equal to <span class="math inline">\(0.1\)</span> of the peak LR. The context length is <span class="math inline">\(256\)</span> tokens and the batch size is <span class="math inline">\(256\)</span>. We tune the max LR separately for each model.</p>
</section>
<section id="co-tam-dalej" class="level2">
<h2>Co tam dalej</h2>
<p>ContMoE vs dense vs expert choice (GPT-BERT mini) Each run was optimized for that many batches of given size Contmoe is better than dense</p>
</section>
</section>
<section id="on-the-horizon" class="level1">
<h1>On the Horizon</h1>
<!-- MK Kto wie czy to dobra nazwa, może Future Work lepsza -->
<p>Coming up in the following weeks, we’re ready to take our work up a notch with a few advancements that we’re covering in this segment.</p>
<section id="temperature-annealing" class="level2">
<h2>Temperature annealing:</h2>
<p>In base MoT setup tokens from various samples in the batch are mingled. This theoretically opens doors for being able to tease out the output of one batch sample by another. However, this may pave the way for potential issues.</p>
<p>To tackle this problem, we plan to conduct an experiment where in the final phase of this experiment will involve a strategic, gradual reduction of temperature, hile simultaneously maintaining a low loss - a process referred to as ‘temerature annealing’. The anticipated outcome is a discrete-routing model which promotes inference parallelization - a move expected to significantly boost the overall efficiency of our processes</p>
</section>
<section id="scaling-up-models" class="level2">
<h2>Scaling Up Models</h2>
<p>In a previous section <TODO check> we showcased results for a BERT-mini FLOP matched Continues-MoE. Our preliminary experiments are also suggesting promising outcomes for larger models. In upcoming weeks we aim to prepare comprehensive comparison of all associated models.</p>
</section>
<section id="do-not-forget-about-a-bert" class="level2">
<h2>Do not forget about a BERT</h2>
<p>As our results in this post covers only GPT model in future work we plan to compare resuts of Continues-MoE with other models on BERT. Our preliminary experiments are also suggesting promising outcomes for larger models. hus, we’re gearing up to provide a thorough comparison of all associated models in upcoming weeks.</p>
</section>
</section>
<section id="conclusions-sj" class="level1">
<h1>Conclusions SJ</h1>
<p>We have shown the preliminary results showing the promise of MoT improving both the stability of training and final performance of the model. More thorough experiments are underway at the moment and we will release the paper with more results in the coming weeks. In the meantime, you can contact us with any feedback you have at llm.random.team@gmail.com .</p>
<div id="quarto-navigation-envelope" class="hidden">
<p><span class="hidden" data-render-id="quarto-int-sidebar-title">llm-random</span> <span class="hidden" data-render-id="quarto-int-navbar-title">llm-random</span> <span class="hidden" data-render-id="quarto-int-navbar:About">About</span> <span class="hidden" data-render-id="quarto-int-navbar:/about.html">/about.html</span></p>
</div>
<div id="quarto-meta-markdown" class="hidden">
<p><span class="hidden" data-render-id="quarto-metatitle">llm-random - Mixture of Tokens</span> <span class="hidden" data-render-id="quarto-twittercardtitle">llm-random - Mixture of Tokens</span> <span class="hidden" data-render-id="quarto-ogcardtitle">llm-random - Mixture of Tokens</span> <span class="hidden" data-render-id="quarto-metasitename">llm-random</span> <span class="hidden" data-render-id="quarto-twittercarddesc"></span> <span class="hidden" data-render-id="quarto-ogcardddesc"></span></p>
</div>
</section>

</main> <!-- /main -->
<script id = "quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->

</body>

</html></iframe></section></main></div></body></html>